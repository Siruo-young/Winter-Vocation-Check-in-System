<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.winter_vacation_checkin.mapper.LaActivityTaskRelationMapper">

    <resultMap id="BaseResultMap" type="com.example.winter_vacation_checkin.domain.LaActivityTaskRelation">
            <id property="id" column="id" />
            <result property="taskId" column="task_id" />
            <result property="activityId" column="activity_id" />
            <result property="sort" column="sort" />
            <result property="createTime" column="create_time" />
            <result property="updateTime" column="update_time" />
            <result property="createUser" column="create_user" />
            <result property="updateUser" column="update_user" />
            <result property="isDelete" column="is_delete" />
    </resultMap>

    <sql id="Base_Column_List">
        id,task_id,activity_id,sort,create_time,update_time,create_user,
        update_user,is_delete
    </sql>
    <update id="updateByActivityId">
        update la_activity_task_relation set is_delete = 0 where activity_id = #{activityId}
    </update>
    <select id="getLastTask" resultType="java.lang.Long">
        select atr.task_id
        from la_activity_task_relation as atr
        left join la_user_task_record as utr
        on atr.activity_id = utr.activity_id
               and atr.task_id = utr.task_id
               and utr.is_delete = 0
               and utr.user_id = #{userId}
        where atr.activity_id = #{activityId}
          and atr.is_delete = 0
          and utr.task_id is null
        order by atr.sort asc
        limit 1
    </select>

</mapper>
